<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Visor EBP – Árbol interactivo</title>
  <style>
    :root{
      --bg:#f6f8fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#cbd5e1; --accent:#1d4ed8;
      --labelFont: 12px;
    }

    /* ✅ Quita scroll vertical global */
    html, body { height: 100%; overflow: hidden; }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--ink);
    }

    header{padding:14px 16px;background:linear-gradient(90deg,#0b2e4a,#0b3a68);color:#fff;}
    header h1{margin:0;font-size:18px;font-weight:700}
    header p{margin:6px 0 0;font-size:12px;opacity:.9}

    .wrap{
      display:grid;
      grid-template-columns:320px 1fr;
      gap:12px;
      padding:12px;
      height:calc(100vh - 64px);
      box-sizing:border-box;
    }

    /* ✅ panel izquierdo con scroll interno, pero sin que la página scrollee */
    .panel{
      background:var(--card);
      border:1px solid #e2e8f0;
      border-radius:14px;
      box-shadow:0 1px 4px rgba(15,23,42,.06);
      overflow:auto;
    }
    .panel .inner{padding:12px;}

    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    select,button{width:100%;padding:10px 10px;border-radius:10px;border:1px solid #e2e8f0;background:#fff;font-size:13px}
    button{cursor:pointer;background:#0ea5e9;color:#fff;border:0;font-weight:700}
    button:hover{filter:brightness(.95)}
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .chip{font-size:11px;padding:4px 8px;border-radius:999px;background:#eef2ff;border:1px solid #e0e7ff;color:#3730a3}
    .hint{margin-top:10px;padding:10px;border-radius:12px;background:#f1f5f9;border:1px dashed #cbd5e1;font-size:12px;color:#334155}

    #svgWrap{position:relative; overflow:hidden;} /* ✅ evita scrollbars */
    svg{
      width:100%;
      height:100%;
      display:block;
      background:var(--card);
      border:1px solid #e2e8f0;
      border-radius:14px;
      box-shadow:0 1px 4px rgba(15,23,42,.06);
    }

    .node rect{fill:#fff;stroke:#94a3b8;stroke-width:1.2;rx:10;ry:10}
    .node .title{font-size:12px;fill:#0f172a;font-weight:650}
    .node .meta{font-size:10px;fill:#64748b}
    .link{fill:none;stroke:#94a3b8;stroke-width:1.2;opacity:.9}
    .node:hover rect{stroke:var(--accent);stroke-width:2}

    @media(max-width:980px){
      .wrap{grid-template-columns:1fr; height:auto}
      svg{height:75vh}
    }

    /* labels inferiores */
    .colLabels{
      position:absolute;
      left:0; right:0;
      bottom:10px;
      pointer-events:none;
      z-index:10;
      height:0;
    }
    .colLabel{
      position:absolute;
      transform:translateX(-50%);
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:12px;
      background:#0f172a;
      color:#fff;
      font-size:var(--labelFont);
      font-weight:800;
      opacity:.92;
      box-shadow:0 6px 16px rgba(15,23,42,.18);
      max-width:340px;
    }
    .colLabel b{
      background:rgba(255,255,255,.18);
      padding:2px 8px;
      border-radius:999px;
      font-size:calc(var(--labelFont) - 1px);
      font-weight:900;
      white-space:nowrap;
    }
    .colLabel span{
      white-space:normal;
      line-height:1.15;
      max-width:260px;
    }
  </style>
</head>

<body>
<header>
  <h1>Visor EBP</h1>
  <p>Estrategia de País del BID 2024 -2027 | Costa Rica</p>
</header>

<div class="wrap">
  <div class="panel">
    <div class="inner">
      <div class="small"><b>Niveles de lectura</b> (elige el orden de atributos)</div>

      <label>Nivel 1</label><select id="lvl1"></select>
      <label>Nivel 2</label><select id="lvl2"></select>
      <label>Nivel 3</label><select id="lvl3"></select>
      <label>Nivel 4</label><select id="lvl4"></select>
      <label>Nivel 5</label><select id="lvl5"></select>

      <div style="height:10px"></div>
      <button id="renderBtn">Renderizar</button>

      <div class="chips" id="orderChips"></div>

      <div class="hint">
        <b>Gestos:</b> arrastra para mover • rueda/trackpad para zoom • click en un nodo para ver detalle abajo.
      </div>

      <hr style="border:none;border-top:1px solid #e2e8f0;margin:12px 0">
      <div class="small"><b>Detalle (click en nodo)</b></div>
      <div id="detail" class="small" style="margin-top:8px;white-space:pre-wrap"></div>
    </div>
  </div>

  <div id="svgWrap">
    <div class="colLabels" id="colLabels"></div>
    <svg id="viz"></svg>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script>
const DEFAULT_LEVELS = ["Área Prioritaria","Objetivo Estratégico","Impacto Esperado","Operaciones vinculadas","Indicador"];
const LABELS = [
  "Área Prioritaria","Objetivo Estratégico","Impacto Esperado","Operaciones vinculadas",
  "Cooperaciones técnicas vinculadas","Indicador","Año","Fuente"
];

const lvlSelects = ["lvl1","lvl2","lvl3","lvl4","lvl5"].map(id=>document.getElementById(id));
const orderChips = document.getElementById("orderChips");
const detail = document.getElementById("detail");
const colLabelsEl = document.getElementById("colLabels");
const svgWrapEl = document.getElementById("svgWrap");

function fillSelect(select, options, selected){
  select.innerHTML = "";
  options.forEach(opt=>{
    const o=document.createElement("option");
    o.value=opt; o.textContent=opt;
    if(opt===selected) o.selected=true;
    select.appendChild(o);
  });
}
function updateChips(levels){
  orderChips.innerHTML="";
  levels.forEach((l,i)=>{
    const d=document.createElement("div");
    d.className="chip";
    d.textContent=`${i+1}. ${l}`;
    orderChips.appendChild(d);
  });
}

lvlSelects.forEach((sel,i)=>fillSelect(sel, LABELS, DEFAULT_LEVELS[i] || LABELS[i]));
updateChips(DEFAULT_LEVELS);

async function loadRows(){
  const res = await fetch("./data.json");
  const data = await res.json();
  return data.rows;
}

function buildTree(rows, levels){
  const root = {name:"EBP Costa Rica 2024-2027", children:[]};

  function getChild(parent, name){
    if(!parent.children) parent.children=[];
    let c = parent.children.find(x=>x.name===name);
    if(!c){ c={name, children:[], _count:0, _rows:[]}; parent.children.push(c); }
    return c;
  }

  rows.forEach(r=>{
    let p=root;
    levels.forEach(lvl=>{
      let v = (r[lvl] ?? "").toString().trim();
      if(!v) v="(Sin dato)";
      p=getChild(p, v);
      p._count += 1;
      p._rows.push(r);
    });
  });

  return root;
}

// ---- D3 ----
const svg = d3.select("#viz");
let g = svg.append("g");

let ROOT_HIER = null;
let CURRENT_LEVELS = [...DEFAULT_LEVELS];
let NODE_CARD_WIDTH = 260;

function setLabelFontByZoom(k){
  const base = 12;
  const scaled = base * k;
  const clamped = Math.max(9, Math.min(22, scaled));
  document.documentElement.style.setProperty("--labelFont", clamped.toFixed(1) + "px");
}

function renderColumnLabels(levels){
  colLabelsEl.innerHTML = "";
  levels.forEach((name, i)=>{
    const div = document.createElement("div");
    div.className = "colLabel";
    div.dataset.depth = String(i+1);
    div.innerHTML = `<b>N${i+1}</b><span>${name}</span>`;
    colLabelsEl.appendChild(div);
  });
}

/* ✅ Oculta labels si su columna no está visible */
function positionColumnLabels(){
  if(!ROOT_HIER) return;

  const t = d3.zoomTransform(svg.node());
  setLabelFontByZoom(t.k);

  const svgRect  = svg.node().getBoundingClientRect();
  const wrapRect = svgWrapEl.getBoundingClientRect();
  const svgOffsetX = svgRect.left - wrapRect.left;

  // rango visible horizontal dentro del contenedor
  const visibleMinX = 0;
  const visibleMaxX = wrapRect.width;

  for(let depth=1; depth<=5; depth++){
    const label = colLabelsEl.querySelector(`.colLabel[data-depth="${depth}"]`);
    if(!label) continue;

    const nodesAtDepth = ROOT_HIER.descendants().filter(d=>d.depth === depth);
    if(nodesAtDepth.length === 0){
      label.style.display = "none";
      continue;
    }

    // mediana de d.y
    const ys = nodesAtDepth.map(d=>d.y).sort((a,b)=>a-b);
    const yMed = ys[Math.floor(ys.length/2)];

    // centro de columna (centro del card)
    const colCenterLayoutX = yMed + (NODE_CARD_WIDTH / 2);

    // a coords pantalla con zoom
    const screenX = t.applyX(colCenterLayoutX);

    // a coords del contenedor
    const leftPx = svgOffsetX + screenX;

    // ✅ si no se ve, NO mostrar
    if(leftPx < visibleMinX || leftPx > visibleMaxX){
      label.style.display = "none";
      continue;
    } else {
      label.style.display = "";
    }

    label.style.left = `${leftPx}px`;
  }
}

let zoom = d3.zoom()
  .scaleExtent([0.2, 2.8])
  .on("zoom", (event)=>{
    g.attr("transform", event.transform);
    positionColumnLabels();
  });

svg.call(zoom);

function wrapText(selection, width){
  selection.each(function(){
    const text = d3.select(this);
    const words = text.text().split(/\s+/).filter(Boolean);
    text.text(null);

    let line = [];
    let lineNumber = 0;
    const lineHeight = 1.25;
    const x = text.attr("x");
    const y = text.attr("y");
    const dy = parseFloat(text.attr("dy") || 0);

    let tspan = text.append("tspan").attr("x", x).attr("y", y).attr("dy", dy + "em");

    for (let i=0; i<words.length; i++){
      line.push(words[i]);
      tspan.text(line.join(" "));
      if (tspan.node().getComputedTextLength() > width){
        line.pop();
        tspan.text(line.join(" "));
        line = [words[i]];
        tspan = text.append("tspan")
          .attr("x", x)
          .attr("y", y)
          .attr("dy", (++lineNumber * lineHeight + dy) + "em")
          .text(words[i]);
      }
    }
  });
}

function render(treeData){
  svg.selectAll("*").remove();
  g = svg.append("g");
  svg.call(zoom);

  const width = svg.node().clientWidth;
  const height = svg.node().clientHeight;

  ROOT_HIER = d3.hierarchy(treeData);

  const nodeCardWidth = 260;
  NODE_CARD_WIDTH = nodeCardWidth;
  const textWrapWidth = nodeCardWidth - 22;

  const treeLayout = d3.tree().nodeSize([90, nodeCardWidth + 90]);
  treeLayout(ROOT_HIER);

  g.selectAll(".link")
    .data(ROOT_HIER.links())
    .join("path")
    .attr("class","link")
    .attr("d", d3.linkHorizontal()
      .x(d => d.y)
      .y(d => d.x)
    );

  const nodes = g.selectAll(".node")
    .data(ROOT_HIER.descendants())
    .join("g")
    .attr("class","node")
    .attr("transform", d => `translate(${d.y},${d.x})`)
    .on("click", (event,d)=>{
      const sample = (d.data._rows && d.data._rows[0]) ? d.data._rows[0] : null;
      const lines = [];
      lines.push(`Nodo: ${d.data.name}`);
      lines.push(`Registros en este camino: ${d.data._count || 0}`);
      if(sample){
        lines.push("");
        lines.push("Ejemplo de fila asociada:");
        Object.keys(sample).forEach(k=>{
          if(["ID","ID_Area"].includes(k)) return;
          const v=(sample[k]??"").toString().trim();
          if(v) lines.push(`- ${k}: ${v}`);
        });
      }
      detail.textContent = lines.join("\n");
    });

  nodes.append("rect")
    .attr("x", 0)
    .attr("y", -28)
    .attr("width", nodeCardWidth)
    .attr("height", 56);

  const title = nodes.append("text")
    .attr("class","title")
    .attr("x", 12)
    .attr("y", -14)
    .attr("dy", 0)
    .text(d=>d.data.name);

  title.call(wrapText, textWrapWidth);

  nodes.append("text")
    .attr("class","meta")
    .attr("x", 12)
    .attr("y", 18)
    .text(d=>{
      const c = d.data._count || (d.children ? d.children.length : 0);
      return d.depth===0 ? "" : `Registros: ${c}`;
    });

  nodes.each(function(d){
    const node = d3.select(this);
    const tspans = node.selectAll("text.title tspan").nodes();
    const lines = tspans.length || 1;
    const titleHeight = Math.max(1, lines) * 15;
    const h = 44 + titleHeight;
    node.select("rect")
      .attr("y", -(h/2))
      .attr("height", h);
    node.select("text.title")
      .attr("y", -(h/2) + 14);
    node.select("text.meta")
      .attr("y", (h/2) - 12);
  });

  renderColumnLabels(CURRENT_LEVELS);

  fitToView();
  function fitToView(){
    const bounds = g.node().getBBox();
    if (bounds.width === 0 || bounds.height === 0) return;

    const midX = bounds.x + bounds.width / 2;
    const midY = bounds.y + bounds.height / 2;

    const scale = 0.95 / Math.max(bounds.width / width, bounds.height / height);
    const translate = [width / 2 - scale * midX, height / 2 - scale * midY];

    svg.transition().duration(400).call(
      zoom.transform,
      d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)
    ).on("end", ()=>{
      positionColumnLabels();
    });
  }

  setTimeout(positionColumnLabels, 450);
}

function getLevelsFromUI(){
  const levels = lvlSelects.map(s=>s.value);
  const used=new Set();

  for(let i=0;i<levels.length;i++){
    if(used.has(levels[i])){
      const repl = LABELS.find(x=>!used.has(x));
      levels[i]=repl;
      lvlSelects[i].value=repl;
    }
    used.add(levels[i]);
  }
  updateChips(levels);
  return levels;
}

let ROWS_CACHE=null;

async function main(){
  ROWS_CACHE = await loadRows();
  CURRENT_LEVELS = getLevelsFromUI();
  const tree = buildTree(ROWS_CACHE, CURRENT_LEVELS);
  render(tree);
}
main();

document.getElementById("renderBtn").onclick = ()=>{
  CURRENT_LEVELS = getLevelsFromUI();
  const tree = buildTree(ROWS_CACHE, CURRENT_LEVELS);
  render(tree);
};
</script>
</body>
</html>
